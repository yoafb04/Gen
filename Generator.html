<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Series Generator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f4; color: #333; padding: 20px; display: flex; justify-content: center; }
.main-wrapper { display: flex; gap: 20px; flex-wrap: wrap; max-width: 1000px; width: 100%; }
.chart-container, .output-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
.chart-container { flex: 1; display: flex; flex-direction: column; }
.output-container { width: 160px; font-family: monospace; font-size: 14px; white-space: pre; overflow-y: visible; max-height: none; height: auto; }
h1 { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; color: #444; }
#refreshBtn { border: none; background: none; cursor: pointer; font-size: 22px; transition: transform 0.3s; }
#refreshBtn:hover { transform: rotate(90deg); }
canvas { width: 100% !important; height: 500px; max-height: 500px; }
.input-row { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; justify-content: center; }
.input-row label { display: flex; flex-direction: column; font-weight: 600; font-size: 14px; align-items: center; }
.input-row input[type="number"] { width: 70px; padding: 6px 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; text-align: center; }
@media(max-width:900px){ .main-wrapper { flex-direction: column; align-items: center; } .output-container { width: 100%; max-width: 200px; margin-top: 15px; } }
.st { color: red; font-weight: bold; }
</style>
</head>
<body>
<div class="main-wrapper">
  <div class="chart-container">
    <h1>
      Series Generator
      <button id="refreshBtn" title="Refresh">ðŸ”„</button>
    </h1>

    <canvas id="seriesChart"></canvas>

    <div class="input-row">
      <label>Baseline <input type="number" id="baseline" min="0" value="100"></label>
      <label>Weeks <input type="number" id="totalWeeks" min="1" value="32"></label>
      <label>Cumplimientos <input type="number" id="totalCumplimientos" min="1" value="3"></label>
      <label>Variability <input type="number" id="stVariability" min="0" value="7"></label>
      <label>Min Gap <input type="number" id="minGap" min="1" value="4"></label>
      <label>Max Gap <input type="number" id="maxGap" min="1" value="6"></label>
    </div>
  </div>

  <div class="output-container" id="output"></div>
</div>

<script>
Chart.register(ChartDataLabels);

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function generateBlock(base, length, variability, maxVal=null) {
    const block = [];
    const counts = {};
    for (let i=0;i<length;i++){
        let min = Math.max(0, base - variability);
        let max = maxVal !== null ? Math.min(base + variability, maxVal) : base + variability;
        let val, tries=0;
        do {
            val = randomInt(min,max);
            tries++;
        } while (counts[val]>=2 && tries<10);
        counts[val] = (counts[val]||0)+1;
        block.push(val);
    }
    return block;
}

function generateSeries(baseline, totalWeeks, totalCumplimientos, stVariability, minGap, maxGap){
    const series=[];
    const stWeeks=[];
    const stTargets={};
    let week=0;
    let lastMastered=baseline;

    series.push(baseline); 
    week++;

    for(let c=0;c<totalCumplimientos;c++){
        const target = Math.floor((lastMastered - 1)/5)*5;

        const gapLength = randomInt(minGap,maxGap);
        let gapBlock = [];

        function violatesFourConsecutive(arr, tgt) {
            let count = 0;
            for (let v of arr) {
                if (v <= tgt) { count++; if (count>=4) return true; }
                else count = 0;
            }
            return false;
        }

        let tries = 0, MAX_TRIES = 200;
        do {
            gapBlock = generateBlock(lastMastered, gapLength, stVariability, lastMastered);
            tries++;
            if (tries === MAX_TRIES) {
                gapBlock = generateBlock(lastMastered, gapLength, Math.max(1, stVariability*2), lastMastered);
                break;
            }
        } while (gapBlock[gapBlock.length - 1]<=target || violatesFourConsecutive(gapBlock,target));

        for(let g of gapBlock){
            if(week>=totalWeeks) break;
            series.push(g);
            week++;
        }

        if(week+4>totalWeeks) break;

        const stBlock = generateBlock(target,4,stVariability,target);
        for(let i=0;i<stBlock.length && week<totalWeeks;i++,week++){
            series.push(stBlock[i]);
            stWeeks.push(week);
            stTargets[week] = target;
        }

        lastMastered=target;
    }

    while(series.length<totalWeeks){
        series.push(randomInt(Math.max(0,lastMastered-stVariability),lastMastered));
    }

    return {series, stWeeks, stTargets};
}

let chart;

function updateSeries(){
    const baseline = parseInt(document.getElementById("baseline").value);
    const totalWeeks = parseInt(document.getElementById("totalWeeks").value);
    const totalCumplimientos = parseInt(document.getElementById("totalCumplimientos").value);
    const stVariability = parseInt(document.getElementById("stVariability").value);
    const minGap = parseInt(document.getElementById("minGap").value);
    const maxGap = parseInt(document.getElementById("maxGap").value);

    const {series, stWeeks, stTargets} = generateSeries(baseline, totalWeeks, totalCumplimientos, stVariability, minGap, maxGap);

    const outputDiv = document.getElementById("output");
    outputDiv.textContent = "";
    for (let i = 0; i < series.length; i++) {
        let v = series[i];
        let line = v.toString();
        if (stWeeks.includes(i)) {
            let tgt = stTargets[i];
            line += "<=" + tgt;
            let lastST = Math.max(...stWeeks.filter(w => stTargets[w]===tgt));
            if (i===lastST) line += "M";
        }
        outputDiv.textContent += line + "\n";
    }

    const labels = Array.from({length: totalWeeks}, (_, i) => i+1);
    const scatterst = stWeeks.map(i => ({x:i+1,y:series[i]}));

    if(chart) chart.destroy();
    const ctx = document.getElementById("seriesChart").getContext("2d");

    chart = new Chart(ctx, {
        type:'line',
        plugins:[ChartDataLabels],
        data:{
            labels: labels,
            datasets:[
                {
                    label:'Series', 
                    data:series, 
                    borderColor:'#2196f3', 
                    fill:false, 
                    tension:0, // step-like line
                    pointRadius:4,
                    pointBackgroundColor:'#2196f3',
                    datalabels:{display:true,color:'#2196f3',font:{size:12},anchor:'end',align:'top'}
                },
                {
                    label:'ST', 
                    data:scatterst, 
                    backgroundColor:'red', 
                    pointRadius:6, 
                    showLine:false, 
                    type:'scatter', 
                    datalabels:{display:false}
                }
            ]
        },
        options:{
            plugins:{legend:{display:true, position:'bottom'}}, 
            scales:{
                y:{
                    beginAtZero:true, 
                    suggestedMax:baseline+10, 
                    ticks:{stepSize:5},
                    grid:{color:'#e0e0e0'}
                },
                x:{
                    title:{display:true,text:'Weeks'},
                    grid:{color:'#e0e0e0'}
                }
            },
            layout:{padding:{top:20}}
        }
    });
}

document.querySelectorAll('.input-row input').forEach(input=>input.addEventListener('input',updateSeries));
document.getElementById("refreshBtn").addEventListener("click",updateSeries);

updateSeries();
</script>

</body>
</html>
